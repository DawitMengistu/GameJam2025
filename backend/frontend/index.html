<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATP</title>
    <link rel="stylesheet" href="font.css">
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Varela+Round&display=swap"
        rel="stylesheet">
</head>

<body>

    <div class="con">
        <div class="game-con">
            <div class="top-half">
                <div class="player-one-con player-con">
                    <img src="player.png" class="playerImg hidden" alt="">
                    <div class="player-one-name-con player-name-con poppins-medium center">
                        Player One
                    </div>
                    <div class="player-one-n poppins-medium center">N</div>
                    <div class="player-one-n poppins-medium center">O</div>
                </div>
                <div class="player-two-con player-con">
                    <img src="player.png" class="playerImg hidden" alt="">
                    <div class="player-two-name-con player-name-con poppins-medium center">Player Two</div>
                    <div class="player-two-n poppins-medium center">N</div>
                    <div class="player-two-n poppins-medium center">O</div>
                </div>
            </div>
            <div class="bottom-half">
                <div class="singleGuess">
                    <div class="player-one-con player-con">
                        <div class="player-one-name-con player-name-con poppins-medium center p1-guess-con guess-con">
                            <div class="single-num center">1</div>
                            <div class="single-num center">5</div>
                            <div class="single-num center">4</div>
                            <div class="single-num center">3</div>
                        </div>
                        <div class="player-one-n poppins-medium center p1-number n-o">1</div>
                        <div class="player-one-n poppins-medium center p1-order n-o">0</div>
                    </div>
                    <div class="player-two-con player-con">

                        <div class="player-one-name-con player-name-con poppins-medium center p2-guess-con guess-con">
                            <div class="single-num center">1</div>
                            <div class="single-num center">5</div>
                            <div class="single-num center">4</div>
                            <div class="single-num center">3</div>
                        </div>

                        <div class="player-two-n poppins-medium center p2-number n-o">0</div>
                        <div class="player-two-n poppins-medium center p2-order n-o">0</div>
                    </div>
                </div>

            </div>
            <div class="bottom-action-cons">
                <input type="number" placeholder="4 digit numbers" name="" id="" class="answer-input poppins-medium">

                <button class="bottom-btn poppins-medium join-game" onclick="handleJoinGame()">Join Game</button>


            </div>
        </div>

    </div>
    <div class="status"></div>
    <!-- 
    <button onclick="handleJoinGame()" class="join-game">Join Game</button>
    <button onclick="handleResignGame()" class="resign-game">Resign</button> -->

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const answerInput = document.querySelector(".answer-input");
        let answer = 0;
        let status = "join"
        let canAddGuess = true;



        const playerImg = document.querySelectorAll(".playerImg");

        const joinGameBtn = document.querySelector(".join-game");
        joinGameBtn.classList.add("btn-disabled");


        answerInput.addEventListener("input", () => {
            const inputValue = answerInput.value;
            if (status === "join") {

                answer = inputValue;
                if (inputValue.toString().length < 4) {
                    joinGameBtn.classList.add("btn-disabled");
                } else {
                    joinGameBtn.classList.remove("btn-disabled");

                }
            } else if (status === "joined" && canAddGuess) {
                if (inputValue.toString().length > 3) {
                    socket.emit('guessput', { roomId: roomId, playerName: playerName, guess: inputValue });



                    answerInput.value = "";
                }
                console.log("Status is to send this numbers", inputValue)
            } else {
                answerInput.value = "";
            }
        });



        const resignGameBtn = document.querySelector(".resign-game");
        const statusText = document.querySelector(".status");


        const singleGuessCon = document.querySelector(".bottom-half")
        const socket = io();
        let roomId = null;
        let playerName = null;
        statusText.innerText = "Join"



        socket.on("gamejoined", (msg) => {

            roomId = msg.roomId;
            playerName = msg.playerName;

            if (playerName == "Player One") {
                statusText.innerText = playerName + "waiting for a partner..."
                joinGameBtn.classList.add("btn-waiting");
                joinGameBtn.innerText = "waiting...";
                playerImg[0].classList.remove("hidden")
                status = "waiting"

            } else {
                statusText.innerText = playerName + "Game Started"
                joinGameBtn.classList.add("btn-started");
                joinGameBtn.innerText = "Resign";
                answerInput.value = "";

                status = "joined"


                playerImg[1].classList.remove("hidden")

            }
        });


        socket.on("gamestarted", (msg) => {

            if (msg.roomId == roomId) {
                joinGameBtn.classList.remove("btn-waiting");
                joinGameBtn.classList.add("btn-started");
                joinGameBtn.innerText = "Resign";
                answerInput.value = "";


                status = "joined"

            }
        });
        socket.on("partnerleft", (msg) => {
            joinGameBtn.classList.remove("btn-started");
            joinGameBtn.classList.remove("btn-waiting");

            playerImg[0].classList.add("hidden")
            playerImg[1].classList.add("hidden")

            joinGameBtn.innerText = "Join Game";
            status = "join"
            playerName = null;
            canAddGuess = true;
            answer = 0;
            joinGameBtn.classList.add("btn-disabled");

            roomId = null;
        });




        socket.on("gameresigned", (msg) => {
            joinGameBtn.classList.remove("btn-started");
            joinGameBtn.classList.remove("btn-waiting");

            playerImg[0].classList.add("hidden")
            playerImg[1].classList.add("hidden")

            joinGameBtn.innerText = "Join Game";
            status = "join"
            playerName = null;
            canAddGuess = true;
            answer = 0;
            joinGameBtn.classList.add("btn-disabled");

            roomId = null;


        });

        socket.on('historyUpdate', (msg) => {
            canAddGuess = msg.historiesAreEqual;
            renderResults(msg.playerOneHistory, msg.playerTwoHistory)
        })


        function handleJoinGame() {

            if (answer.toString().length > 3 && roomId == null) {
                socket.emit('joingame', { answer: answer });
            } else if (joinGameBtn.innerText === "Resign") {
                handleResignGame();
                playerImg[0].classList.add("hidden")
                playerImg[1].classList.add("hidden")
                joinGameBtn.classList.add("btn-disabled");
                answer = 0;

            } else {
                console.log(joinGameBtn.innerText === "Resign", joinGameBtn.innerText)
            }
        }

        function handleResignGame() {
            socket.emit('resigngame', { roomId: roomId, playerName: playerName });

            joinGameBtn.classList.remove("btn-started");
            joinGameBtn.classList.remove("btn-waiting");

            joinGameBtn.innerText = "Join Game";
            status = "join"
            roomId = null;
            playerName = null;
            canAddGuess = true;

            answer = 0;
        }



        function renderResults(playerOneHistory, playerTwoHistory) {
            const maxRounds = Math.max(playerOneHistory.length, playerTwoHistory.length);
            singleGuessCon.innerHTML = "";

            for (let i = 0; i < maxRounds; i++) {
                const p1 = playerOneHistory[i] || [];
                const p2 = playerTwoHistory[i] || [];


                console.log(p1, p2)
                singleGuessCon.innerHTML += singleRound(p1, p2);
            }
        }



        function singleRound(p1, p2) {
            return ` <div class="singleGuess">
                    <div class="player-one-con player-con">
                        <div class="player-one-name-con player-name-con poppins-medium center p1-guess-con guess-con">
                            <div class="single-num center">${p1[0] || ""}</div>
                            <div class="single-num center">${p1[1] || ""}</div>
                            <div class="single-num center">${p1[2] || ""}</div>
                            <div class="single-num center">${p1[3] || ""}</div>
                        </div>
                        <div class="player-one-n poppins-medium center p1-number n-o">${p1[4] || ""}</div>
                        <div class="player-one-n poppins-medium center p1-order n-o">${p1[5] || ""}</div>
                    </div>
                    <div class="player-two-con player-con">

                        <div class="player-one-name-con player-name-con poppins-medium center p2-guess-con guess-con">
                            <div class="single-num center">${p2[0] || ""}</div>
                            <div class="single-num center">${p2[1] || ""}</div>
                            <div class="single-num center">${p2[2] || ""}</div>
                            <div class="single-num center">${p2[3] || ""}</div>
                        </div>

                        <div class="player-two-n poppins-medium center p2-number n-o">${p2[4] || ""}</div>
                        <div class="player-two-n poppins-medium center p2-order n-o">${p2[5] || ""}</div>
                    </div>
                </div>
                `
        }



    </script>
</body>

</html>